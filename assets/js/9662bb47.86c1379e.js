"use strict";(self.webpackChunkcachelib=self.webpackChunkcachelib||[]).push([[8752],{3905:function(e,r,t){t.r(r),t.d(r,{MDXContext:function(){return l},MDXProvider:function(){return m},mdx:function(){return h},useMDXComponents:function(){return u},withMDXComponents:function(){return d}});var n=t(67294);function o(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function a(){return a=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},a.apply(this,arguments)}function i(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function s(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?i(Object(t),!0).forEach((function(r){o(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function c(e,r){if(null==e)return{};var t,n,o=function(e,r){if(null==e)return{};var t,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)t=a[n],r.indexOf(t)>=0||(o[t]=e[t]);return o}(e,r);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)t=a[n],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var l=n.createContext({}),d=function(e){return function(r){var t=u(r.components);return n.createElement(e,a({},r,{components:t}))}},u=function(e){var r=n.useContext(l),t=r;return e&&(t="function"==typeof e?e(r):s(s({},r),e)),t},m=function(e){var r=u(e.components);return n.createElement(l.Provider,{value:r},e.children)},p={inlineCode:"code",wrapper:function(e){var r=e.children;return n.createElement(n.Fragment,{},r)}},f=n.forwardRef((function(e,r){var t=e.components,o=e.mdxType,a=e.originalType,i=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),d=u(t),m=o,f=d["".concat(i,".").concat(m)]||d[m]||p[m]||a;return t?n.createElement(f,s(s({ref:r},l),{},{components:t})):n.createElement(f,s({ref:r},l))}));function h(e,r){var t=arguments,o=r&&r.mdxType;if("string"==typeof e||o){var a=t.length,i=new Array(a);i[0]=f;var s={};for(var c in r)hasOwnProperty.call(r,c)&&(s[c]=r[c]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var l=2;l<a;l++)i[l]=t[l];return n.createElement.apply(null,i)}return n.createElement.apply(null,t)}f.displayName="MDXCreateElement"},43387:function(e,r,t){t.r(r),t.d(r,{assets:function(){return d},contentTitle:function(){return c},default:function(){return p},frontMatter:function(){return s},metadata:function(){return l},toc:function(){return u}});var n=t(83117),o=t(80102),a=(t(67294),t(3905)),i=["components"],s={id:"Cross_Host_Persistence_APIs_Internal",title:"Cross Host Persistence APIs (internal)"},c=void 0,l={unversionedId:"facebook/Cache_Persistence/Cross_Host_Persistence_APIs_Internal",id:"facebook/Cache_Persistence/Cross_Host_Persistence_APIs_Internal",title:"Cross Host Persistence APIs (internal)",description:"Introduction",source:"@site/docs/facebook/Cache_Persistence/cross_host_persistence_APIs_internal.md",sourceDirName:"facebook/Cache_Persistence",slug:"/facebook/Cache_Persistence/Cross_Host_Persistence_APIs_Internal",permalink:"/docs/facebook/Cache_Persistence/Cross_Host_Persistence_APIs_Internal",draft:!1,editUrl:"https://github.com/facebook/CacheLib/edit/main/website/docs/facebook/Cache_Persistence/cross_host_persistence_APIs_internal.md",tags:[],version:"current",frontMatter:{id:"Cross_Host_Persistence_APIs_Internal",title:"Cross Host Persistence APIs (internal)"}},d={},u=[{value:"Introduction",id:"introduction",level:2},{value:"How To Use Manifold Reader And Writer",id:"how-to-use-manifold-reader-and-writer",level:2},{value:"Ture The Performance",id:"ture-the-performance",level:2}],m={toc:u};function p(e){var r=e.components,t=(0,o.Z)(e,i);return(0,a.mdx)("wrapper",(0,n.Z)({},m,t,{components:r,mdxType:"MDXLayout"}),(0,a.mdx)("h2",{id:"introduction"},"Introduction"),(0,a.mdx)("p",null,"Cachelib cross host persistence feature requires user to provide customized stream reader and writer to communicate with backend remote storage. ",(0,a.mdx)("a",{parentName:"p",href:"https://www.internalfb.com/intern/wiki/Manifold/Manifold_Overview/"},"Manifold")," is widely used inside FB as remote storage, and it is most likely to be the first choice of FB users, so Cachelib has provided built-in Manifold reader and writer."),(0,a.mdx)("h2",{id:"how-to-use-manifold-reader-and-writer"},"How To Use Manifold Reader And Writer"),(0,a.mdx)("p",null,(0,a.mdx)("a",{parentName:"p",href:"https://www.internalfb.com/diff/D29218346"},"Reader"),":"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre",className:"language-cpp"},'PersistenceManager manager(cacheConfig);\nManifoldStreamReader reader(\n      "bucket name",\n      "object path",\n      std::chrono::seconds{5000},               // timeout\n      std::thread::hardware_concurrency() - 1,  //parallelDownloads\n      "",                                       //apiKey\n      "",                                       //localPath\n      500 * 1024 * 1024                         //bufferSize 500MB\n);\nmanager.restoreCache(reader);\n')),(0,a.mdx)("p",null,(0,a.mdx)("a",{parentName:"p",href:"https://www.internalfb.com/diff/D29218345"},"Writer"),":"),(0,a.mdx)("pre",null,(0,a.mdx)("code",{parentName:"pre",className:"language-cpp"},'PersistenceManager manager(cacheConfig);\nManifoldStreamWriter writer(\n     "bucket name",\n     "directory path",\n     "filename",\n     true,                                    //userData\n     std::chrono::seconds{5000},              //timeout\n     std::chrono::seconds{50000},             //ttl\n     std::thread::hardware_concurrency() - 1, //parallelUploads\n     "",                                      //apiKey\n     "",                                      //localPath\n     500 * 1024 * 1024,                       //bufferSize 500MB\n );\nmanager.saveCache(writer);\nwriter.close();\n')),(0,a.mdx)("p",null,(0,a.mdx)("a",{parentName:"p",href:"https://www.internalfb.com/diff/D28423748"},"Example"),"."),(0,a.mdx)("h2",{id:"ture-the-performance"},"Ture The Performance"),(0,a.mdx)("p",null,(0,a.mdx)("strong",{parentName:"p"},"Buffer Mode")," in reader downloads part of data to memory from manifold for each time."),(0,a.mdx)("p",null,(0,a.mdx)("strong",{parentName:"p"},"Buffer mode")," in writer uploads data to a separate temporary object in manifold, and concat all temp objects to the target at the end. The temporary objects have fixed 1 day expiry time, so the persistence must finish within 1 day."),(0,a.mdx)("p",null,"This is the default by giving empty localPath in reader/writer constructor, tune ",(0,a.mdx)("strong",{parentName:"p"},"bufferSize")," to get better performance."),(0,a.mdx)("p",null,(0,a.mdx)("strong",{parentName:"p"},"File mode")," in reader downloads the whole file to a local file from manifold at the beginning, and reads a part from the file into memory each time."),(0,a.mdx)("p",null,(0,a.mdx)("strong",{parentName:"p"},"File mode")," in writer persists data to a local file, and upload the file to manifold at the end."),(0,a.mdx)("p",null,"Provide a ",(0,a.mdx)("strong",{parentName:"p"},"localPath")," to enable this mode. The bufferSize doesn\u2019t play a big role in performance but helps in memory usage. User need to ensure no other thread/process is mutating the given file."),(0,a.mdx)("p",null,"To get better performance, user can compare File mode and Buffer mode with various buffer size. Based on previous testing, Buffer mode with large buffer size gives the best performance, while File mode perform better than a small buffer in Buffer mode."),(0,a.mdx)("p",null,(0,a.mdx)("inlineCode",{parentName:"p"},"parallelDownloads")," / ",(0,a.mdx)("inlineCode",{parentName:"p"},"parallelUploads")," are the number of thread Manifold client will use for uploading/downloading objects, more threads gives better performance. Reader and writer will download or upload objects asynchronously in buffer mode, so reader will prepare next data block while the current one is still using by PersistenceManager; writer will return immediately (except flushing) to PersistenceManager and uploads in background."))}p.isMDXComponent=!0}}]);
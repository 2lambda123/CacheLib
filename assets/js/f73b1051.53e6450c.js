"use strict";(self.webpackChunkcachelib=self.webpackChunkcachelib||[]).push([[5782],{3905:function(e,n,o){o.r(n),o.d(n,{MDXContext:function(){return d},MDXProvider:function(){return s},mdx:function(){return p},useMDXComponents:function(){return h},withMDXComponents:function(){return u}});var t=o(67294);function a(e,n,o){return n in e?Object.defineProperty(e,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[n]=o,e}function r(){return r=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var o=arguments[n];for(var t in o)Object.prototype.hasOwnProperty.call(o,t)&&(e[t]=o[t])}return e},r.apply(this,arguments)}function i(e,n){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),o.push.apply(o,t)}return o}function c(e){for(var n=1;n<arguments.length;n++){var o=null!=arguments[n]?arguments[n]:{};n%2?i(Object(o),!0).forEach((function(n){a(e,n,o[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):i(Object(o)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(o,n))}))}return e}function l(e,n){if(null==e)return{};var o,t,a=function(e,n){if(null==e)return{};var o,t,a={},r=Object.keys(e);for(t=0;t<r.length;t++)o=r[t],n.indexOf(o)>=0||(a[o]=e[o]);return a}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(t=0;t<r.length;t++)o=r[t],n.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(a[o]=e[o])}return a}var d=t.createContext({}),u=function(e){return function(n){var o=h(n.components);return t.createElement(e,r({},n,{components:o}))}},h=function(e){var n=t.useContext(d),o=n;return e&&(o="function"==typeof e?e(n):c(c({},n),e)),o},s=function(e){var n=h(e.components);return t.createElement(d.Provider,{value:n},e.children)},m={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},f=t.forwardRef((function(e,n){var o=e.components,a=e.mdxType,r=e.originalType,i=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=h(o),s=a,f=u["".concat(i,".").concat(s)]||u[s]||m[s]||r;return o?t.createElement(f,c(c({ref:n},d),{},{components:o})):t.createElement(f,c({ref:n},d))}));function p(e,n){var o=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var r=o.length,i=new Array(r);i[0]=f;var c={};for(var l in n)hasOwnProperty.call(n,l)&&(c[l]=n[l]);c.originalType=e,c.mdxType="string"==typeof e?e:a,i[1]=c;for(var d=2;d<r;d++)i[d]=o[d];return t.createElement.apply(null,i)}return t.createElement.apply(null,o)}f.displayName="MDXCreateElement"},84518:function(e,n,o){o.r(n),o.d(n,{assets:function(){return u},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return c},metadata:function(){return d},toc:function(){return h}});var t=o(83117),a=o(80102),r=(o(67294),o(3905)),i=["components"],c={id:"Add_monitoring_for_cache",title:"Add monitoring for cache"},l=void 0,d={unversionedId:"facebook/Cache_Monitoring/Add_monitoring_for_cache",id:"facebook/Cache_Monitoring/Add_monitoring_for_cache",title:"Add monitoring for cache",description:"Now that we have a working cache. We need to add monitoring to it. Without ODS and Scuba monitoring, you would be flying blind regarding the performance and health of your cache. CacheLib offers comprehensive monitoring support, and we'll walk you through how to set it up below.",source:"@site/docs/facebook/Cache_Monitoring/Add_monitoring_for_cache.md",sourceDirName:"facebook/Cache_Monitoring",slug:"/facebook/Cache_Monitoring/Add_monitoring_for_cache",permalink:"/docs/facebook/Cache_Monitoring/Add_monitoring_for_cache",draft:!1,editUrl:"https://github.com/facebook/CacheLib/edit/main/website/docs/facebook/Cache_Monitoring/Add_monitoring_for_cache.md",tags:[],version:"current",frontMatter:{id:"Add_monitoring_for_cache",title:"Add monitoring for cache"}},u={},h=[{value:"Background",id:"background",level:2},{value:"Create CacheAdmin",id:"create-cacheadmin",level:2},{value:"Export Stats to ODS",id:"export-stats-to-ods",level:2},{value:"Check Your Stats",id:"check-your-stats",level:2},{value:"Monitor Your Cache",id:"monitor-your-cache",level:2}],s={toc:h};function m(e){var n=e.components,o=(0,a.Z)(e,i);return(0,r.mdx)("wrapper",(0,t.Z)({},s,o,{components:n,mdxType:"MDXLayout"}),(0,r.mdx)("p",null,"Now that we have a working cache. We need to add monitoring to it. Without ODS and Scuba monitoring, you would be flying blind regarding the performance and health of your cache. CacheLib offers comprehensive monitoring support, and we'll walk you through how to set it up below."),(0,r.mdx)("h2",{id:"background"},"Background"),(0,r.mdx)("p",null,"Recall when you instantiated the cache, you have the following header and code:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-cpp"},'#include "cachelib/allocator/CacheAllocator.h"\n\nusing Cache = facebook::cachelib::LruAllocator;\nstd::unique_ptr<Cache> cache;\nfacebook::cachelib::PoolId default_pool;\n\nvoid initializeCache() {\n  Cache::Config config;\n  config\n      .setCacheSize(1 * 1024 * 1024 * 1024) // 1 GB\n      .setCacheName("My cache")\n      .setAccessConfig({25, 10})\n      .validate();\n  cache = std::make_unique<Cache>(config);\n  default_pool =\n      cache->addPool("default", cache->getCacheMemoryStats().ramCacheSize);\n}\n')),(0,r.mdx)("h2",{id:"create-cacheadmin"},"Create CacheAdmin"),(0,r.mdx)("p",null,"To add ",(0,r.mdx)("inlineCode",{parentName:"p"},"CacheAdmin"),", which is the component that will export CacheLib stats to ODS and Scuba, you need to (1) add ",(0,r.mdx)("inlineCode",{parentName:"p"},"//cachelib/facebook/admin:admin")," to your ",(0,r.mdx)("inlineCode",{parentName:"p"},"TARGETS")," file and (2) add the following code:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-cpp"},'#include "cachelib/facebook/admin/CacheAdmin.h"\n\nstd::unique_ptr<cachelib::CacheAdmin> admin;\n\nvoid initializeCache() {\n  ... setting up the cache here\n\n  CacheAdmin::Config adminConfig; // default config should work just fine\n  adminConfig.oncall = "my_team_oncall_shortname"; // Please do not forget to add your team\'s oncall shortname!\n  admin = std::make_unique<CacheAdmin>(*cache, adminConfig);\n}\n')),(0,r.mdx)("h2",{id:"export-stats-to-ods"},"Export Stats to ODS"),(0,r.mdx)("p",null,"Cachelib publishes ODS stats via service data (which exports to the fb303 port). If the service uses Thrift, it should already get the fb303 port as a part of it. Otherwise, you need to open a fb303 port in your service. Once fb303 is setup,  the  monitoring config must be updated to  registers cachelib\u2019s stats. For example, ",(0,r.mdx)("a",{parentName:"p",href:"https://fburl.com/diffusion/tk55n07s"},"see Feed Leaf's fb303 monitoring"),".  Add the following to your monitoring config:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-cpp"},'import cache.cachelib.cachelib.mon.cinc as cachelib\ncachelib.add_cachelib_collector(cfg, "cachelib_fb303", <OPTIONAL: YOUR_FB303_PORT>)\n')),(0,r.mdx)("h2",{id:"check-your-stats"},"Check Your Stats"),(0,r.mdx)("p",null,"After adding the above to your code and configerator monitor config. You want to canary it on the host you intend to run cachelib. And then, you can start up a cache and have it running for about 10 minutes. Then go on ODS and look up the following query:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-none"},"cachelib.<YOUR CACHE NAME>.ram.uptime\n")),(0,r.mdx)("p",null,"You should see the stats shows up. Make sure to check a few more stats to verify they're all being exported. If you see anything missing, reach out cachelib oncall for assistance."),(0,r.mdx)("p",null,"Please refer to ",(0,r.mdx)("a",{parentName:"p",href:"monitoring"},"Monitoring cache health")," for a more in-depth look at the stats we offer on ODS and Scuba."),(0,r.mdx)("h2",{id:"monitor-your-cache"},"Monitor Your Cache"),(0,r.mdx)("p",null,"In addition to building your own dashboard (and adding alarms), you can also use Cachelib's dashboards for high level metrics on how your cache is doing. We offer two dashboards:"),(0,r.mdx)("ol",null,(0,r.mdx)("li",{parentName:"ol"},(0,r.mdx)("a",{parentName:"li",href:"https://fburl.com/unidash/ehpb743v"},"ODS")," - High level cachelib metrics on ODS"),(0,r.mdx)("li",{parentName:"ol"},(0,r.mdx)("a",{parentName:"li",href:"https://fburl.com/unidash/5l3bbo4u"},"Scuba")," - Deeper dive into cachelib's ram cache behavior")),(0,r.mdx)("p",null,"Please contact our oncall if you have a feature request or any ideas to improve these dashboards further."))}m.isMDXComponent=!0}}]);
<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CacheLib Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CacheLib Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="CacheLib" href="/opensearch.xml"><title data-react-helmet="true">Navy Architecture Overview | CacheLib</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-react-helmet="true" name="twitter:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-react-helmet="true" property="og:url" content="https://cachelib.org/docs/Cache_Library_Architecture_Guide/navy_architecture_overview"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Navy Architecture Overview | CacheLib"><meta data-react-helmet="true" name="description" content="Navy is the SSD optimized cache engine leveraged for Hybrid Cache. There are three over-arching goals in the design  of Navy"><meta data-react-helmet="true" property="og:description" content="Navy is the SSD optimized cache engine leveraged for Hybrid Cache. There are three over-arching goals in the design  of Navy"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/navy_architecture_overview"><link data-react-helmet="true" rel="alternate" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/navy_architecture_overview" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://cachelib.org/docs/Cache_Library_Architecture_Guide/navy_architecture_overview" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.118dad3c.css">
<link rel="preload" href="/assets/js/runtime~main.67d812c5.js" as="script">
<link rel="preload" href="/assets/js/main.66604c68.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" style="background-color:#20232a;color:#fff" role="banner"><div class="announcementBarContent_6uhP">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">CacheLib</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/installation/installation">Build and Installation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">API and Usage</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_User_Guides/Cachebench_Overview">Cachebench</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Architecture Guide</a><a class="navbar__item navbar__link" href="/">â€Œ</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/learnmore/">Learn More</a><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_NKBi"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button class="clean-btn backToTopButton_i9tI" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Architecture Guide</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Overview</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">RAM Cache</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Hybrid Cache</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/hybrid_cache">Hybrid Cache</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/navy_architecture_overview">Navy Architecture Overview</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/small_object_cache">Small Object Cache</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_Architecture_Guide/large_object_cache">Large Object Cache</a></li></ul></li></ul></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_XoVD"><div class="docItemContainer_6jsP"><article><header><h1 class="docTitle_ft6A">Navy Architecture Overview</h1></header><div class="markdown"><p>Navy is the SSD optimized cache engine leveraged for Hybrid Cache. There are three over-arching goals in the design  of Navy</p><ol><li>efficient caching for billions of  small (&lt;1KB) and millions of large objects (1KB - 16MB)  on SSDs.</li><li>read optimized point lookups</li><li>Low DRAM overhead</li></ol><p>Since Navy is designed for a cache, it chooses to sacrifice the durability of data when it enables the accomplishment  of the goals above. Caches are effective by constantly churning through the items based on popularity, making them write intensive.  Since write-endurance is a constraint for NVM, the design of Navy optimizes for write-endurance as well.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="implementation-overview"></a>Implementation overview<a class="hash-link" href="#implementation-overview" title="Direct link to heading">#</a></h2><p>Navy&#x27;s implementation is broken down into the following hierarchy.</p><p><img src="/assets/images/Navy_Architecture_overview-3fcba60db4e31d50cd4dd7ea560de0c4.png"></p><p>Navy offers an asynchronous API to it&#x27;s callers.  Navy optimizes for small objects using the Small Item Engine and optimizes for large objects using the Large Item Engine.  Each engine is designed taking into account the DRAM overhead required without compromising read efficiency. Underneath, both the engines operate on top of a block device abstraction.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="device"></a>Device<a class="hash-link" href="#device" title="Direct link to heading">#</a></h3><p>All IO operations within Navy happen over a range of block offsets. <code>Device</code> provides a virtual interface for reads and writes into these offsets. Underneath, the Device could be either a <code>FileDevice</code> implementation over single file on a file system or a raw block device file or a <code>RAID0Device</code> that operates a software raid-0 over  many files or an <code>InMemoryDevice</code> using a malloced buffer (for testing).  <code>Device</code> aligns all reads  from its calles to <code>ioalignSize</code> that is used to configured the <code>Device</code> and trims any extra data that is read.  <code>Device</code> also handles opaque functionality like encryption, chunking, latency measurements for reading and writing while delegating the actual reads or writes to underlying implementation.</p><p><strong>Encryption</strong>: <code>Device</code> can be initialized with a <code>DeviceEncrytor</code> to support block level encryption. All reads and writes pass through the encryption layer and is done at the granularity of encryption block size.  The IO alignment for reads and writes must match the block size used for encryption.</p><p><strong>Chunking</strong>:  Large writes (MBs) can cause head of line blocking for reads on SSDs. To avoid the negative impact on the tail latency for reads, <code>Device</code> can be configured to break up writes into chunks and issue them sequentially. While this can increase the latency for writes, read latency can be improved.  Reads are not broken into chunks. Note, this chunking is orthogonal to the RAID-0 chunking that happens with <code>RAID0Device</code>. Usually the block size for encryption is as small as 4KB and the stripe size for <code>RAID0Device</code> is set to the size of a Navy region(16-64MB).</p><p><strong>LatencyTracking</strong>: Device also tracks the overall latency for reads and writes in a uniform way across all implementations of Device.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="engine-driver"></a>Engine Driver<a class="hash-link" href="#engine-driver" title="Direct link to heading">#</a></h3><p>Items can be cached in either the small or the large item engine depending on their size. While, size is known during insert, lookups and deletes dont, and hence must check both engines before concluding.  Besides this, there are no high level locks per key to synchronize concurrent operations across both the engines. Hence the <code>Driver</code> assumes the responsibility of request processing across the two engines. It accepts Navy API request that are asynchronous in nature and  leverages the <code>JobScheduler</code> to execute them through a state machine below.</p><p><img src="/assets/images/Navy_Engine_driver_state_machine-43043b15a3da639e80a9618b40594dbf.png"></p><p>For example, when a lookup job is enqueued, driver performs the lookup in the Large Item engine first and upon a miss, enqueues another job to perform the lookup to the small item engine. When either results in a final result, the loookup callback is executed inline.</p><p>The driver is also responsible for doing admission policy that are internal to Navy. Currently, Navy implements the following admission policy mechanisms that can be enabled.</p><ol><li><code>RejectRandomAP</code>: Writes are probabilistically rejected based on a configured probabilty.</li><li><code>DynamicRandomAP</code>: Tracks the bytes written at device level and ensures the daily budget is under a specified write rate. This is done by doing probabilistic rejection where the rejection probability is updated every X seconds based on the bytes written so far and the budget available into the future.  To support this, the bytes written from <code>Device</code> is plumbed into the admission policy.</li><li><code>RejectFirstAP</code>: writes to key is rejected upon the first occurence within a configured window. Subsequent write is accepted.</li><li>MaxConcurrentInserts: writes are rejected once sufficient number of them have been queued up.</li><li>MaxParcelMemory: Each insert job has a memory footprint associated. Writes are rejected once sufficient number have been queued up exceeding a certain configured memory footprint.</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="job-scheduler"></a>Job Scheduler<a class="hash-link" href="#job-scheduler" title="Direct link to heading">#</a></h3><p><code>Driver</code> enqueues an API Request as a <code>Job</code> to the <code>JobScheduler</code> in the order it was received. Inside the <code>JobScheduler</code>,  jobs are ordered to avoid concurrent execution of multiple jobs for the same key. This is important given the async nature of the navy API. With this guarantee, callers can make assumptions about the concurrency of operations once enqueued to navy. This is relevant to using  optimistic concurrency by <code>NvmCache</code> implementation.</p><p>To order the jobs, <code>JobScheduler</code> shards the jobs based on its key into one of several fine grained shards (millions). There can be only one job executed for a given request ordering shard at any given time, and if there is already one being executed, the  rest are queued up in a pending job queue. Once the ordering condition is met, Jobs are sharded to be enqueued into one of several <code>JobQueue</code>.  Jobs can be one of the following types; <code>JobType::Read</code> for jobs corresponding to read apis for Navy (lookups), <code>JobType::Write</code> for jobs corresponding to write apis for Navy (inserts and deletes), <code>JobType::Reclaim</code> to perform internal eviction operations and <code>JobType::Flush</code> to perform any internal async bufferred writes.</p><p>The <code>JobScheduler</code> has two executor thread pools (read and write) and Jobs are sharded by key to the appropriate thread pools.  Each  thread in the pool has a corresponding <code>JobQueue</code> and a  dedicated thread associate with processing its  jobs.  Jobs  are processed in FIFO manner, but some Jobs can be enqueued directly to the front of the queue to prioritize over others.  Except <code>JobType::Read</code> all other jobs are executed by the writer pool. While enqueuing, <code>JobType::Reclaim</code> and <code>Jobtype::Flush</code> are given higher priority enqueuing them to the head of the queue. These operations are key agnostic and are internal to Navy and hence can be executed out of order from other read and write operations. Jobs can also be retried based on their exit status returned from the implementation. For example, when performing a lookup, the driver can retry a job to lookup in the small item engine after a lookup in the large item engine returns not found. Jobs are always enqueued to the back of their queue for retry.
<img src="/assets/images/Job_Scheduler-445b781038884832fe0396958a9a7f20.png"></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/CacheLib/edit/main/website/docs/Cache_Library_Architecture_Guide/Navy_Architecture_Overview.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/Cache_Library_Architecture_Guide/hybrid_cache"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Hybrid Cache</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/Cache_Library_Architecture_Guide/small_object_cache"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Small Object Cache Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#implementation-overview" class="table-of-contents__link">Implementation overview</a><ul><li><a href="#device" class="table-of-contents__link">Device</a></li><li><a href="#engine-driver" class="table-of-contents__link">Engine Driver</a></li><li><a href="#job-scheduler" class="table-of-contents__link">Job Scheduler</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Reach Us</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://www.facebook.com/cachelib/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Facebook Developer Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/MetaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_SRtH"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_TMUO themedImage--light_4Vu1 footer__logo"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_TMUO themedImage--dark_uzRr footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.67d812c5.js"></script>
<script src="/assets/js/main.66604c68.js"></script>
</body>
</html>
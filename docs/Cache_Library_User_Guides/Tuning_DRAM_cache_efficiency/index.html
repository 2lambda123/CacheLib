<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CacheLib RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CacheLib Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="CacheLib" href="/opensearch.xml"><title data-react-helmet="true">Tuning DRAM cache efficiency | CacheLib</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-react-helmet="true" name="twitter:image" content="https://cachelib.org/img/CacheLib-Logo-small.png"><meta data-react-helmet="true" property="og:url" content="https://cachelib.org/docs/Cache_Library_User_Guides/Tuning_DRAM_cache_efficiency"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Tuning DRAM cache efficiency | CacheLib"><meta data-react-helmet="true" name="description" content="Reduce fragmentation"><meta data-react-helmet="true" property="og:description" content="Reduce fragmentation"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cachelib.org/docs/Cache_Library_User_Guides/Tuning_DRAM_cache_efficiency"><link data-react-helmet="true" rel="alternate" href="https://cachelib.org/docs/Cache_Library_User_Guides/Tuning_DRAM_cache_efficiency" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://cachelib.org/docs/Cache_Library_User_Guides/Tuning_DRAM_cache_efficiency" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.c097e5a7.css">
<link rel="preload" href="/assets/js/runtime~main.9d5d28f5.js" as="script">
<link rel="preload" href="/assets/js/main.148724d4.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/CacheLib-Logo-small.png" alt="My Facebook Project Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">CacheLib</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/installation/">Build and Installation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">API and Usage</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_User_Guides/Cachebench_Overview">Cachebench</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Cache_Library_Architecture_Guide/overview_a_random_walk">Architecture Guide</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/learnmore/">Learn More</a><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">CacheLib user guide</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/docs/Cache_Library_User_Guides/About_CacheLib">User Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/Cache_Library_User_Guides/About_CacheLib">Overview</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/Cache_Library_User_Guides/Set_up_a_simple_cache">Getting Started with Cache Library</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/Cache_Library_User_Guides/Item_and_Handle">Cache memory management</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/Cache_Library_User_Guides/HybridCache">Hybrid Cache</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/Cache_Library_User_Guides/chained_items">Advanced Features</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" tabindex="0" href="/docs/Cache_Library_User_Guides/Tuning_DRAM_cache_efficiency">Reference</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Cache_Library_User_Guides/Tuning_DRAM_cache_efficiency">Tuning DRAM cache efficiency</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Cache_Library_User_Guides/CacheLib_configs">CacheLib configs</a></li></ul></li></ul></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Tuning DRAM cache efficiency</h1></header><h2 class="anchor anchorWithStickyNavbar_mojV" id="reduce-fragmentation">Reduce fragmentation<a class="hash-link" href="#reduce-fragmentation" title="Direct link to heading">â€‹</a></h2><p>When you use cachelib to allocate memory from cache, you get a piece of memory rounded up to the closest allocation size in the cache. This can lead to wastage of memory (e.g., if you allocate 60 bytes, you get  memory from the 80-byte allocation class; 20 bytes is wasted). Typically, once this grows beyond 5%, there is an opportunity to reduce the fragmentation and increase the usable cache size by tuning the internal allocation sizes.</p><p>To estimate the current fragmentation size, use CacheStat::fragmentationSize to get the current fragmentation bytes and see if the overall volume is more than 5% of your cache size. You can find out the fragmentation per pool by calling PoolStats::totalFragmentation().</p><p><em>Note that changing allocation sizes would need the cache to be dropped if you have cache persistence enabled.</em></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="configure-ttl-reaper">Configure TTL reaper<a class="hash-link" href="#configure-ttl-reaper" title="Direct link to heading">â€‹</a></h2><p>If you have enabled TTL for your objects, reaping them as soon as they expire would free up the space for other objects that can benefit from more cache space. If you donâ€™t pass a TTL to <code>allocate()</code> and you donâ€™t think you have a notion of TTL, you can ignore this.</p><p><strong>Remediation</strong>: Please follow the instructions on <a href="/docs/Cache_Library_User_Guides/ttl_reaper/">time to live on item</a> to turn on the reaper. If you have a reaper already and donâ€™t have the <code>slabWalk</code> mode enabled, enabling it would speed up the reaping of the expired items.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="enable-pool-rebalancing">Enable pool rebalancing<a class="hash-link" href="#enable-pool-rebalancing" title="Direct link to heading">â€‹</a></h2><p>If your objects are of different sizes, their relative memory footprint in the cache might be suboptimal. For example, you might have too many of the large objects hogging space or certain sized objects getting evicted faster than the other. These can lead to suboptimal hit ratios. Turning on pool rebalancing can help in this.</p><p>There isnâ€™t an easy way to tell if this is causing regressions; the easiest way is to experiment on a small test environment with a few <a href="/docs/Cache_Library_User_Guides/pool_rebalance_strategy/#picking-a-strategy">options</a> offered by cachelib. Tuning this often results in improvements to hit ratio.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="avoid-copying-from-cache">Avoid copying from cache<a class="hash-link" href="#avoid-copying-from-cache" title="Direct link to heading">â€‹</a></h2><p>If your mode of operation to access the cache is to copy from cache to deserialize or send out of the network, you can usually avoid the copy by passing the <code>ItemHandle</code> to the appropriate places. For example, if you read from the cache and copy into Thrift reply, you can avoid the copy by converting the <code>ItemHandle</code> into an <code>IOBuf</code>. Similarly, if you copy to deserialize, you can avoid this by deserializing out of the <code>IOBuf</code> from <code>ItemHandle</code>.</p><p>To estimate if this is an issue, collect a cpu profile to see if you spend more than a few % cycles on memcpy variants. If you do, follow some of the examples in <code>convertToIoBuf</code> to try to accomplish similar things.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="tune-eviction-policy">Tune eviction policy<a class="hash-link" href="#tune-eviction-policy" title="Direct link to heading">â€‹</a></h2><p>Both <code>LruAllocator</code> and <code>Lru2QAllocator</code> provide knobs to tune them that are mostly turned off. Trying these out could improve hit ratio. For example, if you are using LRU, trying to turn on mid-point insertion could help get objects that are accessed just once out of the cache faster. Similarly, trying the 2Q allocator captures more access patterns that LRU doesnâ€™t (e.g., 2Q can effectively evict items that have spiky accesses after the spike had ceased).</p><p>For more details on the available knobs, see <a href="/docs/Cache_Library_User_Guides/eviction_policy/">eviction policy</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="reduce-lock-contention">Reduce lock contention<a class="hash-link" href="#reduce-lock-contention" title="Direct link to heading">â€‹</a></h2><p>Cachelib has locks at several granularity to protect the internal data structures. If there is a contention, there are few options to reduce the contention depending on the type.</p><p>To estimate, collect a strobelight profile. If the strobelight profile indicates more than 4% spent on <code>allocate()</code> or <code>insertOrReplace()</code> or <code>find()</code>, there is potential to look into this further.</p><ul><li><p>Contention in <code>insertOrReplace</code>
If you see contention in <code>insertOrReplace</code> resulting in <code>SharedMutex</code> showing up beneath it, usually this is a result of misconfigured Hashtable. This can be tuned by adjusting the <a href="/docs/Cache_Library_User_Guides/Configure_HashTable/#lockspower">lockPower</a>.</p></li><li><p>Contention in <code>addChainedItem</code> (or related functions)
Similar to above, we have a separate hash table to keep track of chained items. If you see contention here, adjust lockPower the same way as above.</p></li><li><p>Contention in LRU
If you notice contention under MMLru or MM2Q, it indicates you have quite a lot of activity (400k/sec+) concentrated around objects of a particular size. To remediate this, we have a few options. If the number of <code>allocate()</code> calls per alloc size is too high, sharding the <code>allocate()</code> calls by creating additional pools would help. If the contention is coming from <code>find()</code>, adjusting the <code>lruRefreshThreshold</code> or turning on <code>dynamicLruRefreshThreshold</code> could help as documented in <a href="/docs/Cache_Library_User_Guides/eviction_policy/">eviction policy</a>.</p></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/Cache_Library_User_Guides/Tuning_DRAM_cache_efficiency.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/Cache_Library_User_Guides/Structured_Cache"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Structured cache</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/Cache_Library_User_Guides/CacheLib_configs"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">CacheLib configs</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#reduce-fragmentation" class="table-of-contents__link toc-highlight">Reduce fragmentation</a></li><li><a href="#configure-ttl-reaper" class="table-of-contents__link toc-highlight">Configure TTL reaper</a></li><li><a href="#enable-pool-rebalancing" class="table-of-contents__link toc-highlight">Enable pool rebalancing</a></li><li><a href="#avoid-copying-from-cache" class="table-of-contents__link toc-highlight">Avoid copying from cache</a></li><li><a href="#tune-eviction-policy" class="table-of-contents__link toc-highlight">Tune eviction policy</a></li><li><a href="#reduce-lock-contention" class="table-of-contents__link toc-highlight">Reduce lock contention</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Reach Us</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/facebook/CacheLib" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://www.facebook.com/cachelib/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Facebook Developer Page<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/MetaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_RC3H"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_W2Cr themedImage--light_TfLj footer__logo"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_W2Cr themedImage--dark_oUvU footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.9d5d28f5.js"></script>
<script src="/assets/js/main.148724d4.js"></script>
</body>
</html>